<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Akshay Kadu">

  <title>Push Notification for Web Application Using GCM</title>
  <link rel="manifest" href="manifest.json"/>
  <!-- Bootstrap Core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/full-width-pics.css" rel="stylesheet">
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-2.1.1.min.js" crossorigin="anonymous"></script>
  <script src="js/gcm.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    //check browser
    var isChrome = !!window.chrome && !!window.chrome.webstore;
    if(!isChrome) {
      alert('Sorry this Demo works only in Chrome Browser.');
    }

    $(function() {
      $('#togglebtn').change(function() {
        console.log('toggle button clicked', $(this).prop('checked'));
        if($(this).prop('checked') === true) {
          if(Notification.permission !== 'granted') {
            Notification.requestPermission().then(function(permission) {
              if(permission === 'granted' && 'serviceWorker' in navigator) {
                navigator.serviceWorker.register('myworker.js').then(initialiseState); 
              } else {
                console.log('service worker not present');
              }
            });
          } 
        } else {
          unsubscribe();
          console.log('off notification');
        }
      });
    });
//get subscription token if already subscribed
if(Notification.permission === 'granted') {
  navigator.serviceWorker.ready.then(function(registration) {
    registration.pushManager.getSubscription().then(function(subscription){
      if(subscription !== null) {
        getToken(subscription);
        $('#togglebtn').prop('checked', true).change();    
      } else {
        $('#togglebtn').prop('checked', false).change();
      }

    });
  });
}
});

function initialiseState() {

//check if notification is supported or not
if(!('showNotification' in ServiceWorkerRegistration.prototype)) {
  console.warn('Notificaiton are not supported');
  return;
}
//check if user has blocked push notification
if(Notification.permission === 'denied'){
  console.warn('User has blocked the notification');
}
//check if push messaging is supported or not
if(!('PushManager' in window)) {
  console.warn('Push messaging is not supported');
  return;
}

//subscribe to GCM
navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
//call subscribe method on serviceWorkerRegistration object
serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly: true})
.then(function(subscription){
  getToken(subscription);
  storeToken(subscription);
}).catch(function(err){
  console.error('Error occured while subscribe(): ', err);
});
});
}

function unsubscribe() {
  navigator.serviceWorker.ready.then(function(serviceWorkerRegistration){
    serviceWorkerRegistration.pushManager.getSubscription().then(function(subscription){
      subscription.unsubscribe().then(function() {

      }).catch(function(err){
        console.error('error while unsubscribe(): ', err);
      });
    });
  })
}
function getToken(subscription) {
  console.log(subscription);
  var token = subscription.endpoint.substring(40, subscription.endpoint.length);
  document.querySelector("#client-token").innerHTML = token;	
}

function storeToken(subscription) {
  var token = subscription.endpoint.substring(40, subscription.endpoint.length);
  firebase.database().ref('tokens/').push({token: token});
}
</script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">

        <a class="navbar-brand" href="#">AKSHAY KADU PRODUCTION</a>
      </div>
    </div>
    <!-- /.container -->
  </nav>

  <!-- Full Width Image Header with Logo -->
  <!-- Image backgrounds are set within the full-width-pics.css file. -->
  <header class="image-bg-fluid-height">
    <a href="http://www.ninjacoders.info">
      <img class="img-responsive img-center" src="http://3.bp.blogspot.com/-Ou7d5RbXaWM/V3VmvW4qOgI/AAAAAAAAA6k/nnQ6II32NIsA2E51sZ4YSlGqBp86lJzBQCK4B/s1600/logo.png&text=Logo" alt="">
    </a>
  </header>

  <!-- Content Section -->
  <section>
    <div class="container">
      <div class="row">
        <div class="col-md-3">
        </div>
        <div class="col-md-6 col-center">
          <h3>Push Notification Demo</h3>

          <input id="togglebtn" type="checkbox" data-toggle="toggle">
        </div>
        <div class="col-md-3">
          <h4>Follow Me</h4>
<a class="twitter-follow-button"
  href="https://twitter.com/ninjakoders">
Follow @TwitterDev</a><br/>
<div class="fb-like" data-href="https://www.facebook.com/ninjakoders/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>
        </div>
      </div>

      <!-- /.row -->
    </div>
    <!-- /.container -->
  </section>
  <section>
    <div class="container">
      <div class="row">
        <div class="col-md-3"></div>
        <div class="col-md-6">
          <div class="table-responsive table-bordered">
            <table class="table">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Endpoint</td>
                  <td><input type="text" id="endpoint" class="form-control" value="https://android.googleapis.com/gcm/send" disabled/></td>
                </tr>
                <tr>
                  <td>Server Key</td>
                  <td><input type="text" id="server-key" class="form-control" value="AIzaSyBTMTUbZc23JBZC7VNfMwj0qwRt-bJvirI" /></td>
                </tr>
                <tr>
                  <td>Client Token</td>
                  <td><textarea id="client-token" rows="6" cols="40"></textarea></td>
                </tr>
                <tr>
                  <td><img src="images/loader.svg" style="display: none" id="loader" /></td>
                  <td>
                    <button class="btn btn-primary" onClick="sendNotification()">
                       <span class="glyphicon glyphicon-bell"></span>
                      Send Notification
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-md-3">
          
<!-- Place this tag where you want the widget to render. -->
<div class="g-person" data-width="256" data-href="//plus.google.com/u/0/109005162369594310226" data-rel="author"></div>
        </div>
      </div>
      <!-- /.row -->
    </div>
    <div class="alert alert-success fade in" id="gcm-success" style="display: none">
      <a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a>
      <strong>Success!</strong> Notification sent.
    </div>
    <div class="alert alert-danger fade in" id="gcm-error" style="display: none">
      <a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a>
      <strong>Failure!</strong> <span id="gcm-error-msg"></span>
    </div>
  </section>
  <section>
    <div class="container">
      <div class="row">
        <div class="col-md-3"></div>
        <div class="col-md-6">
          <h3>HTTP POST Request</h3>
        <pre>
          https://android.googleapis.com/gcm/send
          Content-Type:application/json
          Authorization:key=AIzaSyZ-1u...fMwj0qwRt-bJvirI

          { "data": {
              "message": "How to create PayPal account?",
              "url": "http://www.ninjacoders.info/"
            },
            "to" : "client_token"
          }
        </pre>
        <p>We can't send 'Data' through GCM on browsers, if you send 'Data' in your POST request it will get ignored.</p>
      </div>
      <div class="col-md-3"></div>
      </div>
    </div>
  </section>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <p>Copyright &copy;  2016 <a href="http://www.ninjacoders.info">NinjaCoders</a></p>
        </div>
      </div>
      <!-- /.row -->
    </div>
    <!-- /.container -->
  </footer>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  
<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase.js"></script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=387633358033127";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDzrpolWQMdPrdgvzzTRu3IxEMCIrogmLs",
    authDomain: "gcm-notification-demo-da685.firebaseapp.com",
    databaseURL: "https://gcm-notification-demo-da685.firebaseio.com",
    storageBucket: "",
  };
  firebase.initializeApp(config);
</script>

<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);
 
  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };
 
  return t;
}(document, "script", "twitter-wjs"));</script>
    <!-- Place this tag in your head or just before your close body tag. -->
<script src="https://apis.google.com/js/platform.js" async defer></script>
</body>

</html>